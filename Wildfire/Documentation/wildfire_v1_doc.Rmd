---
title: "Wildfire Model v.1"
subtitle: "Documentation"
author: "Sigal Maya"
date: "6/10/2022"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The climate-health microsimulation model simulates multiple climate-sensitive health outcomes for a user-defined virtual population given various climate and non-climate risk modifiers. The preliminary code for the model is based on the tutorial developed by Krijkamp et al.^1^\ The proof of concept simulates asthma among a hypothetical open cohort of individuals over 20 years. The primary climate-related risk factor is exposure to wildfire smoke.

## 1) Model inputs

Naming conventions:

-   Objects with prefix n. are numbers
-   Objects with prefix v. are vectors
-   Objects with prefix m. are matrices\

### Define model design parameters

-   `n.i`: Cohort size
-   `n.t`: Time horizon
-   `cl`: Cycle length (in years)
-   `v.n`: Vector containing the names of possible health states
-   `n.s`: Number of possible health states
-   `initStates`: Vector of length `n.i` containing initial health states of each individual (by default, everyone begins Healthy)
-   `d.c`: Discount rate for costs
-   `d.e`: Discount rate for health effects (default is equal to `d.c`)
-   `v.intn`: Vector containing names of interventions to be assessed
-   `m.x`: Matrix containing starting population data
-    birth rate and background mortality rate in the population\

### Define transition probabilities

-   Define transition probabilities matrix, `m.transitionGrid`, filled with the probabilities of transitioning between states.
-   Add risk modifiers and associated risk ratios for each transition probability. 

Individual characteristics that are risk modifiers are:

-   age
-   sex
-   smoke exposure\


### Define cost and health effect inputs

Objects with prefix c. denote cost values. Objects with prefix u. denote health state utility values.\



## 2) Define functions

### MicroSim

#### Usage:

```{r MicroSim function, eval=FALSE}
MicroSim(initStates, n.i, n.t, m.fire, m.smoke.exposure.cum, v.n_asthma, m.x, cl, birthRate_bl, birthRate_change, allCauseMortality_bl, allCauseMortality_change, d.c, d.e, TR.out = TRUE, TS.out = TRUE, intn=FALSE, seed = 1)
```

#### Arguments:

-   `initStates`: vector of initial states for each individual
-   `n.i`: number of individuals
-   `n.t`: number of cycles
-   `m.fire`: fire occurrence data
-   `m.smoke.exposure.cum`: cumulative days of smoke exposure by neighborhood each cycle (equivalent to air quality data)
-   `v.n_asthma`: vector of health state names
-   `m.x`: vector or matrix with individual characteristics
-   `cl`: cycle length
-   `birthRate_bl`: annual population birth rate at baseline
-   `birthRate_change`: annual change in population birth rate
-   `allCauseMortality_bl`: annual all-cause mortality at baseline
-   `allCauseMortality_change`: annual change in all-cause mortality
-   `d.c`, `d.e`: discount rates for cost and health outcomes
-   `TR.out`: should the output include a microsimulation trace?
-   `TS.out`: should the output include a transition array between states?
-   `intn`: is there an intervention? (scalar with Boolean value, could be vector of Booleans if some people receive intervention and some don't)
-   `seed`: starting seed number\

The following functions are used:

-   `Probs(...)`: to estimate transition probabilities

-   `Costs(...)`: to estimate costs of state values

-   `Effs(...)`: to estimate health outcomes\

#### Details:

1.  Calculate vectors of discount weights for costs and health effects at each cycle using the formula $\text{discount factor}=1/(1 + \text{discount rate})^{t}$.

2.  Initialize matrices to track health states (`m.M`), costs (`m.C`), and health outcomes (`m.E`). Initialize vector to keep track of total population size each year, `v.totalPop`.

3.  Run the microsimulation algorithm.

    a.  For t=1 to `n.t`, initialize variable `totalBirths_t` to count the number of births in year t. Calculate the birth and death rates at year t.
    For i = 1 to `n.i`, calculate initial costs health effects.
    b.  For t = 1 to `c.t`, create vector of transition probabilities `v.p` for individual i at cycle t, using the `Probs(...)` function, based on prior health state, whether a fire is experienced, and individual characteristics.
    c.  Determine which health state the individual will have next using `v.p`.
    d.  Determine costs and health outcomes based on new health state, whether there is an intervention, and individual characteristics. + Increase age by one.
    e.  Set prior exposure to `TRUE` if a fire has been experienced.
    f.  Close loop for cycles.
    g.  Close loop for individuals.

4.  Results are returned as a list:

    a.  `m.M`: A matrix of size `n.i` x `n.t+1` containing the health state occupied by each individual at each cycle.
    b.  `m.C`: A matrix of size `n.i` x `n.t+1` containing the costs incurred by each individual at each cycle.
    c.  `m.E`: A matrix of size `n.i` x `n.t+1` containing the health outcomes (QALYs) for each individual at each cycle.
    d.  `tc`: Vector of total discounted costs per individual.
    e.  `te`: Vector of total discounted QALYs per individual.
    f.  `tc_hat`: Mean discounted costs
    g.  `te_hat`: Mean discounted QALYs
    h.  `m.x`: Matrix containing the individual characteristics of each individual at the end of the time horizon `n.t`.
    i.  `TS`: A matrix illustrating the state transitions of each individual `n.i` at each cycle `n.t`.
    j.  `TR`: A matrix of size `n.t`x`v.n` containing the health state distribution trace.\

### Probs

#### Usage:

```{r Probs function, eval=FALSE}
Probs(M_it, m.fire_it, m.chars_i, m.smoke.exposure.cum_it)
```

#### Arguments:

-   `M_it`: health state occupied by individual i at cycle t (i.e., `m.M[i,t+1]`)
-   `m.fire_it`: fire experience of individual i at cycle t (i.e., `m.fire[m.x$neighborhood[i],t]`)
-   `m.chars_i`: vector of individual characteristics of individual i (i.e., `m.x[i, ]`)
-   `m.smoke.exposure.cum_it`: cumulative smoke exposure of individual i up to cycle t\

#### Details:

1.  Initialize a vector of length `n.s` to hold state transition probabilities.

2.  Calculate `p.PrmD` conditional on prior wildfire smoke exposure and individual risk modifiers.

3.  Calculate all transitions conditional on the occurrence of a fire and individual risk modifiers.

4.  Assign transition probabilities conditional on current health state.

5.  Return vector of transition probabilities for individual i at cycle t.\

### Costs

#### Usage:

```{r Costs function, eval=FALSE}
Costs(M_it, intervention = FALSE)
```

#### Arguments:

-   `M_it`: health state occupied by individual i at cycle t (i.e., `m.M[i,t+1]`)
-   `intervention`: is there an intervention? (i.e., `intn`)\

#### Details:

1.  Define variable to hold costs.

2.  Assign cost associated with current health state.

3.  Return cost for individual i at cycle t.

Note: In the future, this should also include individual characteristics.\

### Effs

#### Usage:

```{r Effs function, eval=FALSE}
Effs(M_it, intervention = FALSE, m.chars = NULL, cl=1)
```

#### Arguments:

-   `M_it`: health state occupied by individual i at cycle t (i.e., `m.M[i,t+1]`)
-   `intervention`: is there an intervention? (i.e., `intn`)
-   `m.chars`: individual characteristics of individual i at cycle t (i.e., `m.x[i, ]`)\

#### Details:

1.  Define variable to hold utilities.

2.  Assign utility associated with current health state conditional on intervention.

3.  Calculate QALYs using $\text{utility}*\text{cycle length}$.

4.  Return QALYs for individual i at cycle t.

*Note:* Individual characteristics are not yet being used. Future revisions should include the effect of other factors.\

## 3) Run simulation

Run the `MicroSim()` function with a given intervention mix.\

## 4) Future revisions

-   Future revisions should add code to automatically generate figures and tables of interest from simulation results.
-   Include social networks and interaction that may affect health outcomes.
-   Combine this with a second model of a different health outcome.
-   The model currently uses a hypothetical, closed cohort. It needs to be revised to model an open cohort with births, deaths, and immigration. It also needs to incorporate real data.
-   All data in the model are placeholders. They need to be updated to contain real values.
-   Do two versions of graph (one without climate exposure, one with) so that we can see how much the difference is, visually.
-   New people can get asthma diagnosis - have a 0/1 indicator for each condition. \

## References

1.  Krijkamp EM, Alarid-Escudero F, Enns EA, Jalal HJ, Hunink MGM, Pechlivanoglou P. Microsimulation Modeling for Health Decision Sciences Using R: A Tutorial. Med Decis Making. 2018;38(3):400-22. doi: 10.1177/0272989X18754513.
